#include "HardwareLibrary.h"
#include "LuminaryDriverLibrary.h"

#include "UARTConfigure.h"
#include "I2CConfigure.h"
#include "NixieTubeConfigure.h"

void I2C0MasterInitial(void)
{
	unsigned char tempCounter;

	SysCtlPeripheralEnable(SYSCTL_PERIPH_I2C0);					//使能I2C0模块
	I2CMasterInit(I2C0_MASTER_BASE,true);						//400kbps的普通模式
	I2CMasterSpeedSet(I2C0_MASTER_BASE,400000);					//任意设置传输速度
					  											//此处为默认100kbps，可省略
	I2CMasterEnable(I2C0_MASTER_BASE);
	I2CMasterIntEnable(I2C0_MASTER_BASE);
	
	//配置所有PCA9557为输出模式，并关闭所有LED
	I2CMasterTransmit_Burst_2Bytes(I2C0_MASTER_BASE,LED_I2CADDR,PCA9557_REG_CONFIG,0x00);
	I2CMasterTransmit_Burst_2Bytes(I2C0_MASTER_BASE,TUBE_SEG_I2CADDR,PCA9557_REG_CONFIG,0x00);
	I2CMasterTransmit_Burst_2Bytes(I2C0_MASTER_BASE,TUBE_SEL1_I2CADDR,PCA9557_REG_CONFIG,0x00);
	I2CMasterTransmit_Burst_2Bytes(I2C0_MASTER_BASE,TUBE_SEL2_I2CADDR,PCA9557_REG_CONFIG,0x00);

	I2CMasterTransmit_Burst_2Bytes(I2C0_MASTER_BASE,LED_I2CADDR,PCA9557_REG_OUTPUT,0x00);
	I2CMasterTransmit_Burst_2Bytes(I2C0_MASTER_BASE,TUBE_SEG_I2CADDR,PCA9557_REG_OUTPUT,0xff);
	I2CMasterTransmit_Burst_2Bytes(I2C0_MASTER_BASE,TUBE_SEL1_I2CADDR,PCA9557_REG_OUTPUT,0xff);
	I2CMasterTransmit_Burst_2Bytes(I2C0_MASTER_BASE,TUBE_SEL2_I2CADDR,PCA9557_REG_OUTPUT,0xff);
	
	//LED_OnChip启动动画
	for (tempCounter=0;tempCounter<8;tempCounter++)
	{
		LEDSerial<<=1;
		SysCtlDelay(SysCtlClockGet()/60);
		I2CMasterTransmit_Burst_2Bytes(I2C0_MASTER_BASE,LED_I2CADDR,PCA9557_REG_OUTPUT,LEDSerial);
	}
	IntEnable(INT_I2C0);
}

void I2CMasterSpeedSet(unsigned long ulBase, unsigned long ulSpeed) 
{ 
	unsigned long ulClk, ulTPR; 
	ulClk = SysCtlClockGet( );         							//获取当前的系统时钟速率 
	ulTPR = (ulClk / (2 * 10)) / ulSpeed; 
	if (ulTPR < 2) ulTPR = 2;        							//防止过高的速率设置请求 
	if (ulTPR > 256) ulTPR = 256;       						//防止过低的速率设置请求 
 	ulTPR = ulTPR - 1; 
  	HWREG(ulBase + I2C_O_MTPR) = ulTPR; 
}

unsigned char I2CMasterTransmit_Burst_2Bytes
							 (unsigned long ulBase,				//发送完成后才会退出
					 		  unsigned char ucSla,				//从机地址
							  unsigned char ucAddr,				//从机子地址
							  unsigned char ucData)				//传送的1个数据位
{
	I2CMasterSlaveAddrSet(ulBase,ucSla,false);					//false表示主机发送至从机
	I2CMasterDataPut(ulBase,ucAddr);							//设置要发送的子地址
	I2CMasterControl(ulBase,I2C_MASTER_CMD_BURST_SEND_START);	//突发发送起始
	while(I2CMasterBusy(ulBase));
	if (I2CMasterErr(ulBase)!=I2C_MASTER_ERR_NONE)	
	{
		UARTStringPut(UART0_BASE,"I2C0 Transmission Fault!!\r\n");
		return 0;
	}

	I2CMasterDataPut(ulBase,ucData);
	I2CMasterControl(ulBase,I2C_MASTER_CMD_BURST_SEND_FINISH);
	while(I2CMasterBusy(ulBase));
	if (I2CMasterErr(ulBase)!=I2C_MASTER_ERR_NONE)	
	{
		UARTStringPut(UART0_BASE,"I2C0 Transmission Fault!!\r\n");
		return 0;
	}
	return 1;
}

void I2C0DeviceRefresh(void)
{
	NixieTubeCoding();
	I2CMasterSlaveAddrSet(I2C0_MASTER_BASE,TUBE_SEG_I2CADDR,false);			
	I2CMasterDataPut(I2C0_MASTER_BASE,PCA9557_REG_OUTPUT);				
	I2CMasterControl(I2C0_MASTER_BASE,I2C_MASTER_CMD_BURST_SEND_START);
}
